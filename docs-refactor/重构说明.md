# WGARP 重构说明

## 重构概述

本次重构将 WGARP（世界观生成与角色扮演程序）从基于终端的单体应用重构为现代化的微服务架构，支持 Web UI 和 API 接口。

## 架构变更

### 1. 目录结构重构

```
src/
├── core/              # 核心服务层
│   ├── config.py      # 配置管理
│   └── llm.py         # LLM统一接口
├── services/          # 业务服务层
│   ├── __init__.py    # 服务容器
│   ├── world_generation.py    # 世界观生成
│   ├── character_generation.py # 角色生成
│   ├── role_play.py   # 角色扮演
│   ├── save_manager.py # 存档管理
│   ├── save_loader.py # 存档加载
│   └── music_service.py # 音乐服务
├── models/            # 数据模型
│   └── __init__.py    # 所有数据模型定义
├── utils/             # 工具类
│   └── error_handler.py # 错误处理
└── compatibility.py  # 兼容性适配器
```

### 2. 服务分层架构

- **核心层 (Core)**: 配置管理、LLM接口等基础服务
- **服务层 (Services)**: 业务逻辑服务，如世界观生成、角色扮演等
- **模型层 (Models)**: 数据模型和实体定义
- **工具层 (Utils)**: 通用工具和辅助功能

### 3. Web化支持

- **Backend**: FastAPI 后端 API
- **Frontend**: React 前端应用
- **WebSocket**: 实时通信支持

## 主要改进

### 1. 模块化设计
- 每个服务职责单一，易于测试和维护
- 依赖注入，降低模块间耦合
- 统一的错误处理和日志记录

### 2. 异步编程
- 全面支持 async/await
- 提高并发性能
- 更好的用户体验

### 3. 数据模型标准化
- 统一的数据结构定义
- 支持序列化/反序列化
- 类型注解和验证

### 4. 服务容器
- 集中管理服务生命周期
- 自动依赖注入
- 配置统一管理

## 兼容性保证

### 1. 向后兼容
- 保留原有的 API 接口
- 兼容性适配器桥接新旧代码
- 平滑迁移路径

### 2. 多启动模式
- 终端模式：保持原有的终端交互体验
- Web模式：提供现代化的Web界面
- 服务模式：仅运行后端服务

## 使用方式

### 1. 统一启动器
```bash
# 终端模式（默认）
python launcher.py terminal

# Web模式
python launcher.py web --host 0.0.0.0 --port 8000

# 服务模式
python launcher.py service

# 环境检查
python launcher.py --check
```

### 2. 直接启动
```bash
# 传统方式
python main.py

# Web版本
python backend/main.py
```

## 新功能特性

### 1. 智能存档系统
- 自动摘要生成
- 增量式存档
- 存档搜索和管理

### 2. 增强的角色系统
- 角色验证和一致性检查
- 角色修改历史
- 个性化设置

### 3. 改进的音乐系统
- 智能基调选择
- 音乐状态管理
- 多格式支持

### 4. Web界面
- 响应式设计
- 实时通信
- 现代化UI组件

## 开发指南

### 1. 添加新服务
```python
# 1. 在 services/ 目录下创建新服务
class NewService:
    def __init__(self, llm_service, error_handler):
        self.llm_service = llm_service
        self.error_handler = error_handler

# 2. 在 services/__init__.py 中注册
class ServiceContainer:
    async def initialize(self):
        self.new_service = NewService(...)
```

### 2. 添加新模型
```python
# 在 models/__init__.py 中定义
@dataclass
class NewModel:
    field1: str
    field2: Optional[int] = None
    
    def dict(self) -> Dict[str, Any]:
        return dataclasses.asdict(self)
```

### 3. 添加新API
```python
# 在 backend/app/api/routes.py 中添加
@router.post("/api/new-endpoint")
async def new_endpoint(request: NewRequest):
    service = await get_service_container()
    result = await service.get_new_service().method()
    return {"data": result}
```

## 配置说明

### 1. 服务配置
所有服务通过 `config.toml` 文件统一配置：

```toml
[llm]
provider = "zhipu"
api_key = "your_api_key"
model = "glm-4"

[game]
enable_music = true
music_volume = 0.7

[logging]
level = "INFO"
file = "wgarp.log"
```

### 2. 环境变量
```bash
WGARP_CONFIG_PATH=./config.toml
WGARP_LOG_LEVEL=DEBUG
```

## 性能优化

### 1. 内存管理
- 消息历史压缩
- 定期清理过期缓存
- 智能分页加载

### 2. 网络优化
- 请求缓存
- WebSocket连接池
- 异步处理

### 3. 存储优化
- JSON压缩存储
- 增量式更新
- 索引优化

## 测试策略

### 1. 单元测试
```bash
# 运行所有测试
python -m pytest tests/

# 测试特定服务
python -m pytest tests/services/test_world_generation.py
```

### 2. 集成测试
```bash
# API测试
python -m pytest tests/api/

# 端到端测试
python -m pytest tests/e2e/
```

## 部署指南

### 1. 开发环境
```bash
# 安装依赖
pip install -r requirements.txt
pip install -r backend/requirements.txt

# 启动开发服务器
python launcher.py web --host 0.0.0.0 --port 8000
```

### 2. 生产环境
```bash
# 使用Docker
docker-compose up -d

# 或使用Gunicorn
gunicorn backend.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker
```

## 故障排除

### 1. 常见问题
- **导入错误**: 检查Python路径和依赖安装
- **配置错误**: 验证config.toml文件格式和内容
- **API错误**: 检查LLM提供商配置和网络连接

### 2. 日志分析
- 查看 `wgarp.log` 文件
- 使用 `--log-level DEBUG` 获取详细信息
- 检查服务状态和错误堆栈

## 未来规划

### 1. 短期目标
- 完善Web界面功能
- 添加更多测试用例
- 性能优化和bug修复

### 2. 长期目标
- 多语言支持
- 插件系统
- 云部署支持
- 移动端适配

## 贡献指南

1. Fork项目仓库
2. 创建特性分支
3. 提交代码更改
4. 编写测试用例
5. 提交Pull Request

请确保代码符合项目的编码规范和最佳实践。
